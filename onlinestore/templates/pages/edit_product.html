{% extends "base.html" %}
{% load static %}

{% block title %}{% if product %}Редактирование{% else %}Добавление{% endif %} товара{% endblock %}

{% block content %}
<div class="edit-product-page">
    <div class="container" style="padding: 40px 5%; max-width: 900px;">
        <!-- Хлебные крошки -->
        <div style="margin-bottom: 20px;">
            <a href="{% url 'manage_products' %}" style="color: var(--text-secondary); text-decoration: none;">
                <i class="bi bi-arrow-left"></i> Вернуться к управлению товарами
            </a>
        </div>

        <!-- Уведомления -->
        {% if messages %}
        <div style="margin-bottom: 20px;">
            {% for message in messages %}
            <div style="padding: 15px 20px; border-radius: 10px; margin-bottom: 10px;
                        background: {% if message.tags == 'success' %}#d4edda{% elif message.tags == 'warning' %}#fff3cd{% else %}#f8d7da{% endif %};
                        color: {% if message.tags == 'success' %}#155724{% elif message.tags == 'warning' %}#856404{% else %}#721c24{% endif %};
                        border: 1px solid {% if message.tags == 'success' %}#c3e6cb{% elif message.tags == 'warning' %}#ffeeba{% else %}#f5c6cb{% endif %};">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div style="background: white; border-radius: 24px; padding: 40px; border: 1px solid var(--border-color); box-shadow: var(--shadow-lg);">
            <h1 style="font-family: 'Playfair Display'; font-size: 2.2rem; margin-bottom: 30px;">
                {% if product %}Редактирование товара{% else %}Добавление нового товара{% endif %}
            </h1>

            <form method="post" enctype="multipart/form-data" id="productForm">
                {% csrf_token %}

                <!-- Основная информация -->
                <div style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">
                        Название товара <span style="color: #dc3545;">*</span>
                    </label>
                    <input type="text"
                           name="name"
                           value="{{ product.name|default:'' }}"
                           required
                           maxlength="255"
                           style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 12px; font-size: 1rem; transition: var(--transition);"
                           onfocus="this.style.borderColor='var(--accent-primary)'; this.style.outline='none';"
                           onblur="this.style.borderColor='var(--border-color)';">
                </div>

                <div style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">
                        Описание <span style="color: #dc3545;">*</span>
                    </label>
                    <textarea name="description"
                              rows="5"
                              required
                              maxlength="2000"
                              style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 12px; font-size: 1rem; font-family: inherit; transition: var(--transition);"
                              onfocus="this.style.borderColor='var(--accent-primary)'; this.style.outline='none';"
                              onblur="this.style.borderColor='var(--border-color)';">{{ product.description|default:'' }}</textarea>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">
                            Категория <span style="color: #dc3545;">*</span>
                        </label>
                        <select name="category"
                                required
                                style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 12px; font-size: 1rem; background: white; transition: var(--transition);"
                                onfocus="this.style.borderColor='var(--accent-primary)'; this.style.outline='none';"
                                onblur="this.style.borderColor='var(--border-color)';">
                            <option value="">Выберите категорию</option>
                            {% for cat in categories %}
                            <option value="{{ cat.id }}" {% if product and product.category.id == cat.id %}selected{% endif %}>{{ cat.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Пол</label>
                        <select name="gender"
                                style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 12px; font-size: 1rem; background: white; transition: var(--transition);"
                                onfocus="this.style.borderColor='var(--accent-primary)'; this.style.outline='none';"
                                onblur="this.style.borderColor='var(--border-color)';">
                            <option value="">Не выбрано</option>
                            {% for gender in genders %}
                            <option value="{{ gender.id }}" {% if product and product.gender.id == gender.id %}selected{% endif %}>{{ gender.get_name_display }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">
                            Цена <span style="color: #dc3545;">*</span>
                        </label>
                        <div style="position: relative;">
                            <input type="number"
                                   name="price"
                                   id="mainPrice"
                                   value="{{ product.price|default:'' }}"
                                   step="0.01"
                                   min="0"
                                   max="999999.99"
                                   required
                                   style="width: 100%; padding: 12px; padding-right: 50px; border: 2px solid var(--border-color); border-radius: 12px; font-size: 1rem; transition: var(--transition);"
                                   onfocus="this.style.borderColor='var(--accent-primary)'; this.style.outline='none';"
                                   onblur="this.style.borderColor='var(--border-color)';"
                                   oninput="validatePrice(this)">
                            <span style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); font-weight: 500;">₽</span>
                        </div>
                        <small style="display: block; color: var(--text-secondary); margin-top: 5px;">
                            Максимальная цена: 999,999.99 ₽
                        </small>
                    </div>

                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Материал</label>
                        <input type="text"
                               name="material"
                               value="{{ product.material|default:'' }}"
                               maxlength="255"
                               placeholder="Например: 100% хлопок"
                               style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 12px; font-size: 1rem; transition: var(--transition);"
                               onfocus="this.style.borderColor='var(--accent-primary)'; this.style.outline='none';"
                               onblur="this.style.borderColor='var(--border-color)';">
                    </div>
                </div>

                <div style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Уход за изделием</label>
                    <textarea name="care_instructions"
                              rows="3"
                              maxlength="500"
                              placeholder="Например: Стирка при 30°C, не отбеливать, гладить при средней температуре"
                              style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 12px; font-size: 1rem; font-family: inherit; transition: var(--transition);"
                              onfocus="this.style.borderColor='var(--accent-primary)'; this.style.outline='none';"
                              onblur="this.style.borderColor='var(--border-color)';">{{ product.care_instructions|default:'' }}</textarea>
                </div>

                <!-- Варианты товара -->
                <div style="margin: 40px 0 30px;">
                    <h3 style="font-size: 1.3rem; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <i class="bi bi-grid" style="color: var(--accent-primary);"></i>
                        Варианты товара (размеры)
                    </h3>

                    <div style="background: var(--bg-primary); padding: 20px; border-radius: 16px; margin-bottom: 20px;">
                        <!-- Заголовки таблицы вариантов -->
                        <div style="display: grid; grid-template-columns: 100px 100px 120px 120px 40px; gap: 10px; margin-bottom: 15px; padding: 0 10px; font-weight: 600; color: var(--text-primary);">
                            <span>Размер</span>
                            <span>Цвет</span>
                            <span>Цена</span>
                            <span>Количество</span>
                            <span></span>
                        </div>

                        <!-- Контейнер для вариантов -->
                        <div id="variants-container">
                            {% if product and product.variants.exists %}
                                {% for variant in product.variants.all %}
                                <div class="variant-row" style="display: grid; grid-template-columns: 100px 100px 120px 120px 40px; gap: 10px; margin-bottom: 10px;">
                                    <select name="size[]" style="padding: 10px; border: 2px solid var(--border-color); border-radius: 10px; background: white;">
                                        <option value="">Выберите</option>
                                        {% for size in sizes %}
                                        <option value="{{ size.id }}" {% if variant.size and variant.size.id == size.id %}selected{% endif %}>
                                            {{ size.name }}
                                        </option>
                                        {% endfor %}
                                    </select>

                                    <select name="color[]" style="padding: 10px; border: 2px solid var(--border-color); border-radius: 10px; background: white;">
                                        <option value="">Цвет</option>
                                        {% for color in colors %}
                                        <option value="{{ color.id }}" {% if variant.color and variant.color.id == color.id %}selected{% endif %}>
                                            {{ color.name }}
                                        </option>
                                        {% endfor %}
                                    </select>

                                    <div style="position: relative;">
                                        <input type="number"
                                               name="price[]"
                                               value="{{ variant.price }}"
                                               placeholder="Цена"
                                               step="0.01"
                                               min="0"
                                               max="999999.99"
                                               class="variant-price"
                                               style="width: 100%; padding: 10px; padding-right: 25px; border: 2px solid var(--border-color); border-radius: 10px;">
                                        <span style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); color: var(--text-secondary);">₽</span>
                                    </div>

                                    <input type="number"
                                           name="stock[]"
                                           value="{{ variant.stock_quantity }}"
                                           placeholder="Кол-во"
                                           min="0"
                                           max="99999"
                                           style="padding: 10px; border: 2px solid var(--border-color); border-radius: 10px;">

                                    <button type="button" onclick="this.closest('.variant-row').remove()"
                                            style="background: none; border: none; color: #dc3545; cursor: pointer; font-size: 1.2rem;">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                                {% endfor %}
                            {% else %}
                                <!-- Пустой вариант для нового товара -->
                                <div class="variant-row" style="display: grid; grid-template-columns: 100px 100px 120px 120px 40px; gap: 10px; margin-bottom: 10px;">
                                    <select name="size[]" style="padding: 10px; border: 2px solid var(--border-color); border-radius: 10px; background: white;">
                                        <option value="">Выберите</option>
                                        {% for size in sizes %}
                                        <option value="{{ size.id }}">{{ size.name }}</option>
                                        {% endfor %}
                                    </select>

                                    <select name="color[]" style="padding: 10px; border: 2px solid var(--border-color); border-radius: 10px; background: white;">
                                        <option value="">Цвет</option>
                                        {% for color in colors %}
                                        <option value="{{ color.id }}">{{ color.name }}</option>
                                        {% endfor %}
                                    </select>

                                    <div style="position: relative;">
                                        <input type="number"
                                               name="price[]"
                                               placeholder="Цена"
                                               step="0.01"
                                               min="0"
                                               max="999999.99"
                                               class="variant-price"
                                               style="width: 100%; padding: 10px; padding-right: 25px; border: 2px solid var(--border-color); border-radius: 10px;">
                                        <span style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); color: var(--text-secondary);">₽</span>
                                    </div>

                                    <input type="number"
                                           name="stock[]"
                                           placeholder="Кол-во"
                                           min="0"
                                           max="99999"
                                           style="padding: 10px; border: 2px solid var(--border-color); border-radius: 10px;">

                                    <button type="button" onclick="this.closest('.variant-row').remove()"
                                            style="background: none; border: none; color: #dc3545; cursor: pointer; font-size: 1.2rem;">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            {% endif %}
                        </div>

                        <!-- Кнопка добавления варианта -->
                        <button type="button" onclick="addVariantRow()"
                                style="display: inline-flex; align-items: center; gap: 8px; margin-top: 15px; padding: 10px 20px; background: white; border: 2px dashed var(--accent-primary); border-radius: 50px; color: var(--accent-primary); cursor: pointer; transition: var(--transition);"
                                onmouseover="this.style.background='var(--accent-primary)'; this.style.color='white'"
                                onmouseout="this.style.background='white'; this.style.color='var(--accent-primary)'">
                            <i class="bi bi-plus-lg"></i>
                            Добавить вариант
                        </button>
                    </div>

                    <!-- Подсказка -->
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin: 10px 0 0;">
                        <i class="bi bi-info-circle"></i>
                        Доступные размеры: XS, S, M, L, XL, XXL, XXXL
                    </p>
                </div>

                <!-- Изображения -->
                <div style="margin: 40px 0 30px;">
                    <h3 style="font-size: 1.3rem; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <i class="bi bi-images" style="color: var(--accent-primary);"></i>
                        Изображения
                    </h3>

                    {% if product and product.images.exists %}
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px;">
                        {% for image in product.images.all %}
                        <div style="position: relative; width: 100px;">
                            <img src="{{ image.image.url }}" alt="" style="width: 100px; height: 100px; object-fit: cover; border-radius: 12px; border: 2px solid {% if image.is_main %}var(--accent-primary){% else %}transparent{% endif %};">
                            {% if image.is_main %}
                            <span style="position: absolute; top: 5px; right: 5px; background: var(--accent-primary); color: white; padding: 2px 6px; border-radius: 20px; font-size: 0.7rem;">Главное</span>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <div style="border: 2px dashed var(--border-color); border-radius: 16px; padding: 30px; text-align: center; background: var(--bg-primary); position: relative;">
                        <i class="bi bi-cloud-upload" style="font-size: 2.5rem; color: var(--text-secondary);"></i>
                        <p style="margin: 10px 0; color: var(--text-secondary);">Перетащите файлы сюда или нажмите для выбора</p>
                        <input type="file" name="images" multiple accept="image/*"
                               style="position: absolute; opacity: 0; width: 100%; height: 100%; top: 0; left: 0; cursor: pointer;">
                    </div>
                    <small style="display: block; color: var(--text-secondary); margin-top: 5px;">
                        Поддерживаемые форматы: JPG, PNG, WEBP. Максимальный размер: 5MB
                    </small>
                </div>

                <!-- Статус -->
                <div style="margin: 30px 0;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 15px; background: var(--bg-primary); border-radius: 12px;">
                        <input type="checkbox" name="is_active" {% if product.is_active or not product %}checked{% endif %} style="width: 18px; height: 18px;">
                        <span style="font-weight: 500;">Товар активен (отображается на сайте)</span>
                    </label>
                </div>

                <!-- Кнопки -->
                <div style="display: flex; gap: 15px; margin-top: 40px;">
                    <button type="submit" class="btn-main" style="flex: 1; padding: 15px; font-size: 1.1rem;" id="submitBtn">
                        <i class="bi bi-check-lg" style="margin-right: 8px;"></i>
                        {% if product %}Сохранить изменения{% else %}Создать товар{% endif %}
                    </button>
                    <a href="{% url 'manage_products' %}" class="btn-outline" style="flex: 1; padding: 15px; text-align: center; text-decoration: none; font-size: 1.1rem;">
                        <i class="bi bi-x-lg" style="margin-right: 8px;"></i>Отмена
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Функция добавления новой строки варианта
function addVariantRow() {
    const container = document.getElementById('variants-container');
    const row = document.createElement('div');
    row.className = 'variant-row';
    row.style.cssText = 'display: grid; grid-template-columns: 100px 100px 120px 120px 40px; gap: 10px; margin-bottom: 10px;';

    row.innerHTML = `
        <select name="size[]" style="padding: 10px; border: 2px solid var(--border-color); border-radius: 10px; background: white;">
            <option value="">Выберите</option>
            {% for size in sizes %}
            <option value="{{ size.id }}">{{ size.name }}</option>
            {% endfor %}
        </select>

        <select name="color[]" style="padding: 10px; border: 2px solid var(--border-color); border-radius: 10px; background: white;">
            <option value="">Цвет</option>
            {% for color in colors %}
            <option value="{{ color.id }}">{{ color.name }}</option>
            {% endfor %}
        </select>

        <div style="position: relative;">
            <input type="number" name="price[]" placeholder="Цена" step="0.01" min="0" max="999999.99" class="variant-price" style="width: 100%; padding: 10px; padding-right: 25px; border: 2px solid var(--border-color); border-radius: 10px;">
            <span style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); color: var(--text-secondary);">₽</span>
        </div>

        <input type="number" name="stock[]" placeholder="Кол-во" min="0" max="99999" style="padding: 10px; border: 2px solid var(--border-color); border-radius: 10px;">

        <button type="button" onclick="this.closest('.variant-row').remove()" style="background: none; border: none; color: #dc3545; cursor: pointer; font-size: 1.2rem;">
            <i class="bi bi-trash"></i>
        </button>
    `;

    container.appendChild(row);
}

// Функция валидации цены
function validatePrice(input) {
    const maxPrice = 999999.99;
    let value = parseFloat(input.value);

    if (input.value && !isNaN(value)) {
        if (value > maxPrice) {
            input.value = maxPrice;
            showNotification('Цена не может превышать 999,999.99 ₽', 'warning');
        } else if (value < 0) {
            input.value = 0;
            showNotification('Цена не может быть отрицательной', 'warning');
        }
    }
}

// Валидация всей формы перед отправкой
document.getElementById('productForm').addEventListener('submit', function(e) {
    let hasError = false;
    const mainPrice = document.getElementById('mainPrice');

    // Проверяем основную цену
    if (mainPrice.value) {
        validatePrice(mainPrice);
    }

    // Проверяем цены вариантов
    document.querySelectorAll('.variant-price').forEach(input => {
        if (input.value) {
            validatePrice(input);
        }
    });

    // Проверяем обязательные поля
    const requiredFields = document.querySelectorAll('[required]');
    requiredFields.forEach(field => {
        if (!field.value.trim()) {
            field.style.borderColor = '#dc3545';
            hasError = true;
        } else {
            field.style.borderColor = 'var(--border-color)';
        }
    });

    if (hasError) {
        e.preventDefault();
        showNotification('Заполните все обязательные поля', 'error');
    }
});

// Функция показа уведомлений
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: ${type === 'warning' ? '#fff3cd' : '#f8d7da'};
        color: ${type === 'warning' ? '#856404' : '#721c24'};
        border: 1px solid ${type === 'warning' ? '#ffeeba' : '#f5c6cb'};
        border-radius: 12px;
        padding: 1rem 2rem;
        box-shadow: var(--shadow-md);
        z-index: 9999;
        animation: slideIn 0.3s ease;
        max-width: 360px;
    `;
    notification.textContent = message;

    document.body.appendChild(notification);

    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Добавляем обработчики для всех полей цены
document.addEventListener('DOMContentLoaded', function() {
    const priceInputs = document.querySelectorAll('input[type="number"][name="price"], input[type="number"].variant-price');
    priceInputs.forEach(input => {
        input.addEventListener('blur', function() {
            validatePrice(this);
        });
    });
});
</script>

<style>
@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOut {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

.variant-row {
    transition: all 0.2s ease;
}

.variant-row:hover {
    background: rgba(0,0,0,0.02);
}

input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
    opacity: 0.5;
}

input[type="number"]:hover::-webkit-inner-spin-button,
input[type="number"]:hover::-webkit-outer-spin-button {
    opacity: 1;
}

/* Адаптивность для мобильных */
@media (max-width: 768px) {
    .variant-row {
        grid-template-columns: 1fr !important;
        gap: 10px;
        padding: 15px;
        background: #f8f8f8;
        border-radius: 12px;
    }

    .edit-product-page .container {
        padding: 20px 3%;
    }

    .edit-product-page > div {
        padding: 30px !important;
    }
}
</style>
{% endblock %}
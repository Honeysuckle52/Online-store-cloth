{% extends "base.html" %}
{% load static %}

{% block title %}{% if product %}Редактирование{% else %}Добавление{% endif %} товара{% endblock %}

{% block content %}
<div class="edit-product-page">
    <div class="container" style="padding: 40px 5%; max-width: 900px;">
        <div style="background: white; border-radius: 24px; padding: 40px; border: 1px solid var(--border-color); box-shadow: var(--shadow-lg);">
            <h1 style="font-family: 'Playfair Display'; font-size: 2.2rem; margin-bottom: 30px;">
                {% if product %}Редактирование товара{% else %}Добавление нового товара{% endif %}
            </h1>

            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}

                <!-- Основная информация -->
                <div style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Название товара *</label>
                    <input type="text" name="name" value="{{ product.name|default:'' }}" required
                           style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 12px; font-size: 1rem;">
                </div>

                <div style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Описание *</label>
                    <textarea name="description" rows="5" required
                              style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 12px; font-size: 1rem;">{{ product.description|default:'' }}</textarea>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Категория *</label>
                        <select name="category" required
                                style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 12px; font-size: 1rem;">
                            <option value="">Выберите категорию</option>
                            {% for cat in categories %}
                            <option value="{{ cat.id }}" {% if product and product.category.id == cat.id %}selected{% endif %}>{{ cat.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Пол</label>
                        <select name="gender"
                                style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 12px; font-size: 1rem;">
                            <option value="">Не выбрано</option>
                            {% for gender in genders %}
                            <option value="{{ gender.id }}" {% if product and product.gender.id == gender.id %}selected{% endif %}>{{ gender.get_name_display }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Цена *</label>
                        <input type="number" name="price" value="{{ product.price|default:'' }}" step="0.01" min="0" required
                               style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 12px; font-size: 1rem;">
                    </div>

                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Материал</label>
                        <input type="text" name="material" value="{{ product.material|default:'' }}"
                               style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 12px; font-size: 1rem;">
                    </div>
                </div>

                <div style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Уход за изделием</label>
                    <textarea name="care_instructions" rows="3"
                              style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 12px; font-size: 1rem;">{{ product.care_instructions|default:'' }}</textarea>
                </div>

                <!-- Варианты товара -->
                <div style="margin: 40px 0 30px;">
                    <h3 style="font-size: 1.3rem; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <i class="bi bi-grid" style="color: var(--accent-primary);"></i>
                        Варианты товара (размеры)
                    </h3>

                    <div style="background: var(--bg-primary); padding: 20px; border-radius: 16px; margin-bottom: 20px;">
                        <!-- Заголовки таблицы вариантов -->
                        <div style="display: grid; grid-template-columns: 100px 100px 120px 120px 40px; gap: 10px; margin-bottom: 15px; padding: 0 10px; font-weight: 600; color: var(--text-primary);">
                            <span>Размер</span>
                            <span>Цвет</span>
                            <span>Цена</span>
                            <span>Количество</span>
                            <span></span>
                        </div>

                        <!-- Контейнер для вариантов -->
                        <div id="variants-container">
                            {% if product and product.variants.exists %}
                                {% for variant in product.variants.all %}
                                <div class="variant-row" style="display: grid; grid-template-columns: 100px 100px 120px 120px 40px; gap: 10px; margin-bottom: 10px;">
                                    <select name="size[]" style="padding: 10px; border: 2px solid var(--border-color); border-radius: 10px; background: white;">
                                        <option value="">Выберите</option>
                                        {% for size in sizes %}
                                        <option value="{{ size.id }}" {% if variant.size and variant.size.id == size.id %}selected{% endif %}>
                                            {{ size.name }}
                                        </option>
                                        {% endfor %}
                                    </select>

                                    <select name="color[]" style="padding: 10px; border: 2px solid var(--border-color); border-radius: 10px; background: white;">
                                        <option value="">Цвет</option>
                                        {% for color in colors %}
                                        <option value="{{ color.id }}" {% if variant.color and variant.color.id == color.id %}selected{% endif %}>
                                            {{ color.name }}
                                        </option>
                                        {% endfor %}
                                    </select>

                                    <input type="number" name="price[]" value="{{ variant.price }}" placeholder="Цена" step="0.01" min="0"
                                           style="padding: 10px; border: 2px solid var(--border-color); border-radius: 10px;">

                                    <input type="number" name="stock[]" value="{{ variant.stock_quantity }}" placeholder="Кол-во" min="0"
                                           style="padding: 10px; border: 2px solid var(--border-color); border-radius: 10px;">

                                    <button type="button" onclick="this.closest('.variant-row').remove()"
                                            style="background: none; border: none; color: #dc3545; cursor: pointer; font-size: 1.2rem;">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                                {% endfor %}
                            {% else %}
                                <!-- Пустой вариант для нового товара -->
                                <div class="variant-row" style="display: grid; grid-template-columns: 100px 100px 120px 120px 40px; gap: 10px; margin-bottom: 10px;">
                                    <select name="size[]" style="padding: 10px; border: 2px solid var(--border-color); border-radius: 10px; background: white;">
                                        <option value="">Выберите</option>
                                        {% for size in sizes %}
                                        <option value="{{ size.id }}">{{ size.name }}</option>
                                        {% endfor %}
                                    </select>

                                    <select name="color[]" style="padding: 10px; border: 2px solid var(--border-color); border-radius: 10px; background: white;">
                                        <option value="">Цвет</option>
                                        {% for color in colors %}
                                        <option value="{{ color.id }}">{{ color.name }}</option>
                                        {% endfor %}
                                    </select>

                                    <input type="number" name="price[]" placeholder="Цена" step="0.01" min="0"
                                           style="padding: 10px; border: 2px solid var(--border-color); border-radius: 10px;">

                                    <input type="number" name="stock[]" placeholder="Кол-во" min="0"
                                           style="padding: 10px; border: 2px solid var(--border-color); border-radius: 10px;">

                                    <button type="button" onclick="this.closest('.variant-row').remove()"
                                            style="background: none; border: none; color: #dc3545; cursor: pointer; font-size: 1.2rem;">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            {% endif %}
                        </div>

                        <!-- Кнопка добавления варианта -->
                        <button type="button" onclick="addVariantRow()"
                                style="display: inline-flex; align-items: center; gap: 8px; margin-top: 15px; padding: 10px 20px; background: white; border: 2px dashed var(--accent-primary); border-radius: 50px; color: var(--accent-primary); cursor: pointer; transition: var(--transition);"
                                onmouseover="this.style.background='var(--accent-primary)'; this.style.color='white'"
                                onmouseout="this.style.background='white'; this.style.color='var(--accent-primary)'">
                            <i class="bi bi-plus-lg"></i>
                            Добавить вариант
                        </button>
                    </div>

                    <!-- Подсказка -->
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin: 10px 0 0;">
                        <i class="bi bi-info-circle"></i>
                        Доступные размеры: XS, S, M, L, XL, XXL, XXXL
                    </p>
                </div>

                <!-- Изображения -->
                <div style="margin: 40px 0 30px;">
                    <h3 style="font-size: 1.3rem; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <i class="bi bi-images" style="color: var(--accent-primary);"></i>
                        Изображения
                    </h3>

                    {% if product and product.images.exists %}
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px;">
                        {% for image in product.images.all %}
                        <div style="position: relative; width: 100px;">
                            <img src="{{ image.image.url }}" alt="" style="width: 100px; height: 100px; object-fit: cover; border-radius: 12px; border: 2px solid {% if image.is_main %}var(--accent-primary){% else %}transparent{% endif %};">
                            {% if image.is_main %}
                            <span style="position: absolute; top: 5px; right: 5px; background: var(--accent-primary); color: white; padding: 2px 6px; border-radius: 20px; font-size: 0.7rem;">Главное</span>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <div style="border: 2px dashed var(--border-color); border-radius: 16px; padding: 30px; text-align: center; background: var(--bg-primary); position: relative;">
                        <i class="bi bi-cloud-upload" style="font-size: 2.5rem; color: var(--text-secondary);"></i>
                        <p style="margin: 10px 0; color: var(--text-secondary);">Перетащите файлы сюда или нажмите для выбора</p>
                        <input type="file" name="images" multiple accept="image/*"
                               style="position: absolute; opacity: 0; width: 100%; height: 100%; top: 0; left: 0; cursor: pointer;">
                    </div>
                </div>

                <!-- Статус -->
                <div style="margin: 30px 0;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 15px; background: var(--bg-primary); border-radius: 12px;">
                        <input type="checkbox" name="is_active" {% if product.is_active or not product %}checked{% endif %} style="width: 18px; height: 18px;">
                        <span style="font-weight: 500;">Товар активен (отображается на сайте)</span>
                    </label>
                </div>

                <!-- Кнопки -->
                <div style="display: flex; gap: 15px; margin-top: 40px;">
                    <button type="submit" class="btn-main" style="flex: 1; padding: 15px; font-size: 1.1rem;">
                        <i class="bi bi-check-lg" style="margin-right: 8px;"></i>
                        {% if product %}Сохранить изменения{% else %}Создать товар{% endif %}
                    </button>
                    <a href="{% url 'manage_products' %}" class="btn-outline" style="flex: 1; padding: 15px; text-align: center; text-decoration: none; font-size: 1.1rem;">
                        <i class="bi bi-x-lg" style="margin-right: 8px;"></i>Отмена
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function addVariantRow() {
    const container = document.getElementById('variants-container');
    const row = document.createElement('div');
    row.className = 'variant-row';
    row.style.cssText = 'display: grid; grid-template-columns: 100px 100px 120px 120px 40px; gap: 10px; margin-bottom: 10px;';

    // Получаем HTML для выбора размеров из шаблона
    const sizeOptions = `{% for size in sizes %}<option value="{{ size.id }}">{{ size.name }}</option>{% endfor %}`;
    const colorOptions = `{% for color in colors %}<option value="{{ color.id }}">{{ color.name }}</option>{% endfor %}`;

    row.innerHTML = `
        <select name="size[]" style="padding: 10px; border: 2px solid var(--border-color); border-radius: 10px; background: white;">
            <option value="">Выберите</option>
            {% for size in sizes %}
            <option value="{{ size.id }}">{{ size.name }}</option>
            {% endfor %}
        </select>

        <select name="color[]" style="padding: 10px; border: 2px solid var(--border-color); border-radius: 10px; background: white;">
            <option value="">Цвет</option>
            {% for color in colors %}
            <option value="{{ color.id }}">{{ color.name }}</option>
            {% endfor %}
        </select>

        <input type="number" name="price[]" placeholder="Цена" step="0.01" min="0"
               style="padding: 10px; border: 2px solid var(--border-color); border-radius: 10px;">

        <input type="number" name="stock[]" placeholder="Кол-во" min="0"
               style="padding: 10px; border: 2px solid var(--border-color); border-radius: 10px;">

        <button type="button" onclick="this.closest('.variant-row').remove()"
                style="background: none; border: none; color: #dc3545; cursor: pointer; font-size: 1.2rem;">
            <i class="bi bi-trash"></i>
        </button>
    `;

    container.appendChild(row);
}

// Удаляем числовые размеры из базы данных
document.addEventListener('DOMContentLoaded', function() {
    // Это просто для информации, реальное удаление нужно делать через Django
    console.log('Доступные размеры должны быть только буквенными: XS, S, M, L, XL, XXL, XXXL');
});
</script>

<style>
/* Дополнительные стили для страницы редактирования */
.variant-row {
    transition: var(--transition);
}

.variant-row:hover {
    background: white;
    box-shadow: var(--shadow-sm);
}

.variant-row select,
.variant-row input {
    transition: var(--transition);
}

.variant-row select:focus,
.variant-row input:focus {
    border-color: var(--accent-primary) !important;
    outline: none;
    box-shadow: 0 0 0 3px rgba(212, 163, 115, 0.1);
}
</style>
{% endblock %}